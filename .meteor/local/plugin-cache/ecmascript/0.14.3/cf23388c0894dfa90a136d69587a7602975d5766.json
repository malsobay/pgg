{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/tilenbabnik/Desktop/pgg/packages/empirica:core/ui/containers/GameContainer.jsx","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser"},"sourceFileName":"packages/empirica:core/ui/containers/GameContainer.jsx","filename":"/Users/tilenbabnik/Desktop/pgg/packages/empirica:core/ui/containers/GameContainer.jsx","passPerPreset":false,"envName":"development","cwd":"/Users/tilenbabnik/Desktop/pgg","root":"/Users/tilenbabnik/Desktop/pgg","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.9.2","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/tilenbabnik/Desktop/pgg/packages/empirica:core/ui/containers/GameContainer.jsx","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/empirica:core/ui/containers/GameContainer.jsx"}},"code":"let _objectSpread;\n\nmodule.link(\"@babel/runtime/helpers/objectSpread2\", {\n  default(v) {\n    _objectSpread = v;\n  }\n\n}, 0);\n\nlet _objectWithoutProperties;\n\nmodule.link(\"@babel/runtime/helpers/objectWithoutProperties\", {\n  default(v) {\n    _objectWithoutProperties = v;\n  }\n\n}, 1);\nlet TimeSync;\nmodule.link(\"meteor/mizzao:timesync\", {\n  TimeSync(v) {\n    TimeSync = v;\n  }\n\n}, 0);\nlet withTracker;\nmodule.link(\"meteor/react-meteor-data\", {\n  withTracker(v) {\n    withTracker = v;\n  }\n\n}, 1);\nlet moment;\nmodule.link(\"moment\", {\n  default(v) {\n    moment = v;\n  }\n\n}, 2);\nlet PlayerRounds;\nmodule.link(\"../../api/player-rounds/player-rounds\", {\n  PlayerRounds(v) {\n    PlayerRounds = v;\n  }\n\n}, 3);\nlet augmentGameStageRound, augmentPlayer, augmentPlayerLobby, augmentPlayerStageRound, augmentGameLobby;\nmodule.link(\"../../api/player-stages/augment\", {\n  augmentGameStageRound(v) {\n    augmentGameStageRound = v;\n  },\n\n  augmentPlayer(v) {\n    augmentPlayer = v;\n  },\n\n  augmentPlayerLobby(v) {\n    augmentPlayerLobby = v;\n  },\n\n  augmentPlayerStageRound(v) {\n    augmentPlayerStageRound = v;\n  },\n\n  augmentGameLobby(v) {\n    augmentGameLobby = v;\n  }\n\n}, 4);\nlet PlayerStages;\nmodule.link(\"../../api/player-stages/player-stages\", {\n  PlayerStages(v) {\n    PlayerStages = v;\n  }\n\n}, 5);\nlet Players;\nmodule.link(\"../../api/players/players\", {\n  Players(v) {\n    Players = v;\n  }\n\n}, 6);\nlet Rounds;\nmodule.link(\"../../api/rounds/rounds\", {\n  Rounds(v) {\n    Rounds = v;\n  }\n\n}, 7);\nlet Stages;\nmodule.link(\"../../api/stages/stages\", {\n  Stages(v) {\n    Stages = v;\n  }\n\n}, 8);\nlet Treatments;\nmodule.link(\"../../api/treatments/treatments.js\", {\n  Treatments(v) {\n    Treatments = v;\n  }\n\n}, 9);\nlet Game;\nmodule.link(\"../components/Game.jsx\", {\n  default(v) {\n    Game = v;\n  }\n\n}, 10);\nconst loadingObj = {\n  loading: true\n}; // Handles all the timing stuff\n\nconst withTimer = withTracker((_ref) => {\n  let {\n    game,\n    stage,\n    player\n  } = _ref,\n      rest = _objectWithoutProperties(_ref, [\"game\", \"stage\", \"player\"]);\n\n  // We no longer need timers if the game ended, skip the timing stuff.\n  if (game && game.finishedAt) {\n    return {\n      game,\n      stage,\n      player\n    };\n  } // TimeSync.serverTime() is a reactive source that will trigger this\n  // withTracker function every 1s.\n\n\n  const now = moment(TimeSync.serverTime(null, 100));\n  const startTimeAt = stage && stage.startTimeAt && moment(stage.startTimeAt);\n  const started = startTimeAt && now.isSameOrAfter(startTimeAt);\n  const endTimeAt = startTimeAt && startTimeAt.add(stage.durationInSeconds, \"seconds\");\n  const ended = endTimeAt && now.isSameOrAfter(endTimeAt);\n  const timedOut = stage && !player.stage.submitted && ended;\n  const roundOver = stage && player.stage.submitted || timedOut;\n  return _objectSpread({\n    game,\n    stage,\n    player,\n    timedOut,\n    roundOver,\n    started,\n    ended,\n    endTimeAt\n  }, rest);\n})(Game); // Handles all the info below game\n\nconst withGameInfo = withTracker((_ref2) => {\n  let {\n    game,\n    gameLobby,\n    player,\n    treatment\n  } = _ref2,\n      rest = _objectWithoutProperties(_ref2, [\"game\", \"gameLobby\", \"player\", \"treatment\"]);\n\n  if (!game) {\n    return {\n      gameLobby,\n      player,\n      treatment\n    };\n  }\n\n  const gameId = game._id;\n  treatment = Treatments.findOne(game.treatmentId);\n\n  if (!treatment) {\n    return loadingObj;\n  }\n\n  game.treatment = treatment.factorsObject();\n  game.players = Players.find({\n    gameId\n  }).fetch();\n  game.rounds = Rounds.find({\n    gameId\n  }, {\n    sort: {\n      index: 1\n    }\n  }).fetch();\n  game.rounds.forEach(round => {\n    round.stages = Stages.find({\n      roundId: round._id\n    }, {\n      sort: {\n        index: 1\n      }\n    }).fetch();\n  });\n  const stage = Stages.findOne(game.currentStageId);\n\n  if (!stage) {\n    return loadingObj;\n  }\n\n  const round = game.rounds.find(r => r._id === stage.roundId); // We're having streaming updates from the backend that put us in an\n  // uncertain state until everything is loaded correctly.\n\n  const playerIds = game.players.map(p => p._id);\n  const playerStagesCount = PlayerStages.find({\n    stageId: stage._id,\n    playerId: {\n      $in: playerIds\n    }\n  }).count();\n  const playerRoundsCount = PlayerRounds.find({\n    roundId: round._id,\n    playerId: {\n      $in: playerIds\n    }\n  }).count();\n\n  if (playerIds.length !== playerStagesCount || playerIds.length !== playerRoundsCount) {\n    return loadingObj;\n  }\n\n  augmentGameStageRound(game, stage, round);\n\n  const applyAugment = player => {\n    player.stage = {\n      _id: stage._id\n    };\n    player.round = {\n      _id: round._id\n    };\n    augmentPlayerStageRound(player, player.stage, player.round, game);\n  };\n\n  applyAugment(player);\n  game.players.forEach(applyAugment);\n\n  const params = _objectSpread({}, rest, {\n    game,\n    round,\n    stage,\n    player,\n    treatment,\n    playerStagesCount,\n    playerRoundsCount\n  });\n\n  return params;\n})(withTimer); // Loads top level Players, Game, Round and Stage data\n\nmodule.exportDefault(withTracker((_ref3) => {\n  let {\n    player,\n    gameLobby,\n    game\n  } = _ref3,\n      rest = _objectWithoutProperties(_ref3, [\"player\", \"gameLobby\", \"game\"]);\n\n  // If no game, we're at lobby level\n  if (!game) {\n    if (!gameLobby) {\n      throw new Error(\"game not found\");\n    }\n\n    const treatment = Treatments.findOne(gameLobby.treatmentId);\n\n    if (!treatment) {\n      return loadingObj;\n    }\n\n    gameLobby.treatment = treatment.factorsObject();\n    gameLobby.queuedCount = gameLobby.queuedPlayerIds.length;\n    gameLobby.readyCount = gameLobby.playerIds.length;\n    gameLobby.players = Players.find({\n      _id: {\n        $in: gameLobby.playerIds\n      }\n    }).fetch();\n    gameLobby.players.forEach(p => augmentPlayerLobby(p, {}, {}, gameLobby));\n    augmentGameLobby(gameLobby);\n    augmentPlayerLobby(player, {}, {}, gameLobby);\n    return _objectSpread({}, rest, {\n      gameLobby,\n      player,\n      treatment\n    });\n  }\n\n  return _objectSpread({}, rest, {\n    game,\n    player\n  });\n})(withGameInfo));","map":{"version":3,"sources":["packages/empirica:core/ui/containers/GameContainer.jsx"],"names":["_objectSpread","module","link","default","v","_objectWithoutProperties","TimeSync","withTracker","moment","PlayerRounds","augmentGameStageRound","augmentPlayer","augmentPlayerLobby","augmentPlayerStageRound","augmentGameLobby","PlayerStages","Players","Rounds","Stages","Treatments","Game","loadingObj","loading","withTimer","game","stage","player","rest","finishedAt","now","serverTime","startTimeAt","started","isSameOrAfter","endTimeAt","add","durationInSeconds","ended","timedOut","submitted","roundOver","withGameInfo","gameLobby","treatment","gameId","_id","findOne","treatmentId","factorsObject","players","find","fetch","rounds","sort","index","forEach","round","stages","roundId","currentStageId","r","playerIds","map","p","playerStagesCount","stageId","playerId","$in","count","playerRoundsCount","length","applyAugment","params","exportDefault","Error","queuedCount","queuedPlayerIds","readyCount"],"mappings":"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","sourcesContent":["// gameContainer.jsx\n\nimport { TimeSync } from \"meteor/mizzao:timesync\";\nimport { withTracker } from \"meteor/react-meteor-data\";\nimport moment from \"moment\";\nimport { PlayerRounds } from \"../../api/player-rounds/player-rounds\";\nimport {\n  augmentGameStageRound,\n  augmentPlayer,\n  augmentPlayerLobby,\n  augmentPlayerStageRound,\n  augmentGameLobby\n} from \"../../api/player-stages/augment\";\nimport { PlayerStages } from \"../../api/player-stages/player-stages\";\nimport { Players } from \"../../api/players/players\";\nimport { Rounds } from \"../../api/rounds/rounds\";\nimport { Stages } from \"../../api/stages/stages\";\nimport { Treatments } from \"../../api/treatments/treatments.js\";\nimport Game from \"../components/Game.jsx\";\n\nconst loadingObj = { loading: true };\n\n// Handles all the timing stuff\nconst withTimer = withTracker(({ game, stage, player, ...rest }) => {\n  // We no longer need timers if the game ended, skip the timing stuff.\n  if (game && game.finishedAt) {\n    return { game, stage, player };\n  }\n\n  // TimeSync.serverTime() is a reactive source that will trigger this\n  // withTracker function every 1s.\n  const now = moment(TimeSync.serverTime(null, 100));\n\n  const startTimeAt = stage && stage.startTimeAt && moment(stage.startTimeAt);\n  const started = startTimeAt && now.isSameOrAfter(startTimeAt);\n  const endTimeAt =\n    startTimeAt && startTimeAt.add(stage.durationInSeconds, \"seconds\");\n  const ended = endTimeAt && now.isSameOrAfter(endTimeAt);\n  const timedOut = stage && !player.stage.submitted && ended;\n  const roundOver = (stage && player.stage.submitted) || timedOut;\n\n  return {\n    game,\n    stage,\n    player,\n    timedOut,\n    roundOver,\n    started,\n    ended,\n    endTimeAt,\n    ...rest\n  };\n})(Game);\n\n// Handles all the info below game\nconst withGameInfo = withTracker(\n  ({ game, gameLobby, player, treatment, ...rest }) => {\n    if (!game) {\n      return {\n        gameLobby,\n        player,\n        treatment\n      };\n    }\n\n    const gameId = game._id;\n    treatment = Treatments.findOne(game.treatmentId);\n    if (!treatment) {\n      return loadingObj;\n    }\n\n    game.treatment = treatment.factorsObject();\n    game.players = Players.find({ gameId }).fetch();\n    game.rounds = Rounds.find({ gameId }, { sort: { index: 1 } }).fetch();\n    game.rounds.forEach(round => {\n      round.stages = Stages.find(\n        { roundId: round._id },\n        { sort: { index: 1 } }\n      ).fetch();\n    });\n\n    const stage = Stages.findOne(game.currentStageId);\n    if (!stage) {\n      return loadingObj;\n    }\n    const round = game.rounds.find(r => r._id === stage.roundId);\n\n    // We're having streaming updates from the backend that put us in an\n    // uncertain state until everything is loaded correctly.\n    const playerIds = game.players.map(p => p._id);\n    const playerStagesCount = PlayerStages.find({\n      stageId: stage._id,\n      playerId: { $in: playerIds }\n    }).count();\n    const playerRoundsCount = PlayerRounds.find({\n      roundId: round._id,\n      playerId: { $in: playerIds }\n    }).count();\n\n    if (\n      playerIds.length !== playerStagesCount ||\n      playerIds.length !== playerRoundsCount\n    ) {\n      return loadingObj;\n    }\n\n    augmentGameStageRound(game, stage, round);\n    const applyAugment = player => {\n      player.stage = { _id: stage._id };\n      player.round = { _id: round._id };\n      augmentPlayerStageRound(player, player.stage, player.round, game);\n    };\n    applyAugment(player);\n    game.players.forEach(applyAugment);\n\n    const params = {\n      ...rest,\n      game,\n      round,\n      stage,\n      player,\n      treatment,\n      playerStagesCount,\n      playerRoundsCount\n    };\n\n    return params;\n  }\n)(withTimer);\n\n// Loads top level Players, Game, Round and Stage data\nexport default withTracker(({ player, gameLobby, game, ...rest }) => {\n  // If no game, we're at lobby level\n  if (!game) {\n    if (!gameLobby) {\n      throw new Error(\"game not found\");\n    }\n    const treatment = Treatments.findOne(gameLobby.treatmentId);\n    if (!treatment) {\n      return loadingObj;\n    }\n\n    gameLobby.treatment = treatment.factorsObject();\n    gameLobby.queuedCount = gameLobby.queuedPlayerIds.length;\n    gameLobby.readyCount = gameLobby.playerIds.length;\n    gameLobby.players = Players.find({\n      _id: { $in: gameLobby.playerIds }\n    }).fetch();\n\n    gameLobby.players.forEach(p => augmentPlayerLobby(p, {}, {}, gameLobby));\n\n    augmentGameLobby(gameLobby);\n    augmentPlayerLobby(player, {}, {}, gameLobby);\n\n    return {\n      ...rest,\n      gameLobby,\n      player,\n      treatment\n    };\n  }\n\n  return {\n    ...rest,\n    game,\n    player\n  };\n})(withGameInfo);\n"]},"sourceType":"module","hash":"cf23388c0894dfa90a136d69587a7602975d5766"}
