{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/mosobay/Dropbox (MIT)/research/pgg/pgg_empirica/packages/reywood:publish-composite/lib/subscription.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"packages/reywood:publish-composite/lib/subscription.js","filename":"/Users/mosobay/Dropbox (MIT)/research/pgg/pgg_empirica/packages/reywood:publish-composite/lib/subscription.js","passPerPreset":false,"envName":"production","cwd":"/Users/mosobay/Dropbox (MIT)/research/pgg/pgg_empirica","root":"/Users/mosobay/Dropbox (MIT)/research/pgg/pgg_empirica","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.9.2","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/mosobay/Dropbox (MIT)/research/pgg/pgg_empirica/packages/reywood:publish-composite/lib/subscription.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/reywood:publish-composite/lib/subscription.js"}},"code":"let _;\n\nmodule.link(\"meteor/underscore\", {\n  _(v) {\n    _ = v;\n  }\n\n}, 0);\nlet DocumentRefCounter;\nmodule.link(\"./doc_ref_counter\", {\n  default(v) {\n    DocumentRefCounter = v;\n  }\n\n}, 1);\nlet debugLog;\nmodule.link(\"./logging\", {\n  debugLog(v) {\n    debugLog = v;\n  }\n\n}, 2);\n\nclass Subscription {\n  constructor(meteorSub) {\n    this.meteorSub = meteorSub;\n    this.docHash = {};\n    this.refCounter = new DocumentRefCounter({\n      onChange: (collectionName, docId, refCount) => {\n        debugLog('Subscription.refCounter.onChange', \"\".concat(collectionName, \":\").concat(docId.valueOf(), \" \").concat(refCount));\n\n        if (refCount <= 0) {\n          meteorSub.removed(collectionName, docId);\n\n          this._removeDocHash(collectionName, docId);\n        }\n      }\n    });\n  }\n\n  added(collectionName, doc) {\n    this.refCounter.increment(collectionName, doc._id);\n\n    if (this._hasDocChanged(collectionName, doc._id, doc)) {\n      debugLog('Subscription.added', \"\".concat(collectionName, \":\").concat(doc._id));\n      this.meteorSub.added(collectionName, doc._id, doc);\n\n      this._addDocHash(collectionName, doc);\n    }\n  }\n\n  changed(collectionName, id, changes) {\n    if (this._shouldSendChanges(collectionName, id, changes)) {\n      debugLog('Subscription.changed', \"\".concat(collectionName, \":\").concat(id));\n      this.meteorSub.changed(collectionName, id, changes);\n\n      this._updateDocHash(collectionName, id, changes);\n    }\n  }\n\n  removed(collectionName, id) {\n    debugLog('Subscription.removed', \"\".concat(collectionName, \":\").concat(id.valueOf()));\n    this.refCounter.decrement(collectionName, id);\n  }\n\n  _addDocHash(collectionName, doc) {\n    this.docHash[buildHashKey(collectionName, doc._id)] = doc;\n  }\n\n  _updateDocHash(collectionName, id, changes) {\n    const key = buildHashKey(collectionName, id);\n    const existingDoc = this.docHash[key] || {};\n    this.docHash[key] = _.extend(existingDoc, changes);\n  }\n\n  _shouldSendChanges(collectionName, id, changes) {\n    return this._isDocPublished(collectionName, id) && this._hasDocChanged(collectionName, id, changes);\n  }\n\n  _isDocPublished(collectionName, id) {\n    const key = buildHashKey(collectionName, id);\n    return !!this.docHash[key];\n  }\n\n  _hasDocChanged(collectionName, id, doc) {\n    const existingDoc = this.docHash[buildHashKey(collectionName, id)];\n\n    if (!existingDoc) {\n      return true;\n    }\n\n    return _.any(_.keys(doc), key => !_.isEqual(doc[key], existingDoc[key]));\n  }\n\n  _removeDocHash(collectionName, id) {\n    const key = buildHashKey(collectionName, id);\n    delete this.docHash[key];\n  }\n\n}\n\nfunction buildHashKey(collectionName, id) {\n  return \"\".concat(collectionName, \"::\").concat(id.valueOf());\n}\n\nmodule.exportDefault(Subscription);","map":{"version":3,"sources":["packages/reywood:publish-composite/lib/subscription.js"],"names":["_","module","link","v","DocumentRefCounter","default","debugLog","Subscription","constructor","meteorSub","docHash","refCounter","onChange","collectionName","docId","refCount","valueOf","removed","_removeDocHash","added","doc","increment","_id","_hasDocChanged","_addDocHash","changed","id","changes","_shouldSendChanges","_updateDocHash","decrement","buildHashKey","key","existingDoc","extend","_isDocPublished","any","keys","isEqual","exportDefault"],"mappings":"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","sourcesContent":["import { _ } from 'meteor/underscore';\n\nimport DocumentRefCounter from './doc_ref_counter';\nimport { debugLog } from './logging';\n\n\nclass Subscription {\n    constructor(meteorSub) {\n        this.meteorSub = meteorSub;\n        this.docHash = {};\n        this.refCounter = new DocumentRefCounter({\n            onChange: (collectionName, docId, refCount) => {\n                debugLog('Subscription.refCounter.onChange', `${collectionName}:${docId.valueOf()} ${refCount}`);\n                if (refCount <= 0) {\n                    meteorSub.removed(collectionName, docId);\n                    this._removeDocHash(collectionName, docId);\n                }\n            },\n        });\n    }\n\n    added(collectionName, doc) {\n        this.refCounter.increment(collectionName, doc._id);\n\n        if (this._hasDocChanged(collectionName, doc._id, doc)) {\n            debugLog('Subscription.added', `${collectionName}:${doc._id}`);\n            this.meteorSub.added(collectionName, doc._id, doc);\n            this._addDocHash(collectionName, doc);\n        }\n    }\n\n    changed(collectionName, id, changes) {\n        if (this._shouldSendChanges(collectionName, id, changes)) {\n            debugLog('Subscription.changed', `${collectionName}:${id}`);\n            this.meteorSub.changed(collectionName, id, changes);\n            this._updateDocHash(collectionName, id, changes);\n        }\n    }\n\n    removed(collectionName, id) {\n        debugLog('Subscription.removed', `${collectionName}:${id.valueOf()}`);\n        this.refCounter.decrement(collectionName, id);\n    }\n\n    _addDocHash(collectionName, doc) {\n        this.docHash[buildHashKey(collectionName, doc._id)] = doc;\n    }\n\n    _updateDocHash(collectionName, id, changes) {\n        const key = buildHashKey(collectionName, id);\n        const existingDoc = this.docHash[key] || {};\n        this.docHash[key] = _.extend(existingDoc, changes);\n    }\n\n    _shouldSendChanges(collectionName, id, changes) {\n        return this._isDocPublished(collectionName, id) &&\n            this._hasDocChanged(collectionName, id, changes);\n    }\n\n    _isDocPublished(collectionName, id) {\n        const key = buildHashKey(collectionName, id);\n        return !!this.docHash[key];\n    }\n\n    _hasDocChanged(collectionName, id, doc) {\n        const existingDoc = this.docHash[buildHashKey(collectionName, id)];\n\n        if (!existingDoc) { return true; }\n\n        return _.any(_.keys(doc), key => !_.isEqual(doc[key], existingDoc[key]));\n    }\n\n    _removeDocHash(collectionName, id) {\n        const key = buildHashKey(collectionName, id);\n        delete this.docHash[key];\n    }\n}\n\nfunction buildHashKey(collectionName, id) {\n    return `${collectionName}::${id.valueOf()}`;\n}\n\nexport default Subscription;\n"]},"sourceType":"module","hash":"b257fc456471d00dfb1db51501fd823a837356d3"}
