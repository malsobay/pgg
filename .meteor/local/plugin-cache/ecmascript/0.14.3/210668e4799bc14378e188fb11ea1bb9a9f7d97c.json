{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/mosobay/Dropbox (MIT)/research/pgg/pgg_empirica/packages/empirica:core/server.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"packages/empirica:core/server.js","filename":"/Users/mosobay/Dropbox (MIT)/research/pgg/pgg_empirica/packages/empirica:core/server.js","passPerPreset":false,"envName":"production","cwd":"/Users/mosobay/Dropbox (MIT)/research/pgg/pgg_empirica","root":"/Users/mosobay/Dropbox (MIT)/research/pgg/pgg_empirica","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.9.2","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/mosobay/Dropbox (MIT)/research/pgg/pgg_empirica/packages/empirica:core/server.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/empirica:core/server.js"}},"code":"module.export({\n  config: () => config\n});\nmodule.link(\"./startup/server/index.js\");\nlet SimpleSchema;\nmodule.link(\"simpl-schema\", {\n  default(v) {\n    SimpleSchema = v;\n  }\n\n}, 0);\nlet playerIdForConn;\nmodule.link(\"./startup/server/connections.js\", {\n  playerIdForConn(v) {\n    playerIdForConn = v;\n  }\n\n}, 1);\nlet callOnChange;\nmodule.link(\"./api/server/onchange.js\", {\n  callOnChange(v) {\n    callOnChange = v;\n  }\n\n}, 2);\nlet callOnSubmit;\nmodule.link(\"./api/server/onsubmit.js\", {\n  callOnSubmit(v) {\n    callOnSubmit = v;\n  }\n\n}, 3);\nlet earlyExitGame;\nmodule.link(\"./api/games/methods.js\", {\n  earlyExitGame(v) {\n    earlyExitGame = v;\n  }\n\n}, 4);\nlet shared;\nmodule.link(\"./shared\", {\n  default(v) {\n    shared = v;\n  }\n\n}, 5);\nlet getFunctionParameters;\nmodule.link(\"./lib/utils\", {\n  getFunctionParameters(v) {\n    getFunctionParameters = v;\n  }\n\n}, 6);\nlet Games;\nmodule.link(\"./api/games/games.js\", {\n  Games(v) {\n    Games = v;\n  }\n\n}, 7);\nSimpleSchema.debug = true;\n\nconst safeCallback = function (name, func, arguments) {\n  try {\n    switch (name) {\n      case \"onGameStart\":\n      case \"onRoundStart\":\n      case \"onStageStart\":\n      case \"onStageEnd\":\n      case \"onRoundEnd\":\n      case \"onGameEnd\":\n        handleCallbackFuncParameters(func);\n        break;\n\n      default:\n        break;\n    }\n\n    const game = Games.findOne(arguments[0]._id);\n\n    if (game.finishedAt) {\n      console.log(\"safeCallback: game already ended.\");\n      return;\n    }\n\n    return func.apply(this, arguments);\n  } catch (err) {\n    console.error(\"Fatal error encounter calling Empirica.\".concat(name, \":\"));\n    console.error(err);\n    const game = arguments[0];\n    earlyExitGame.call({\n      gameId: game._id,\n      endReason: \"Failed on \".concat(name, \" callback\"),\n      status: \"failed\"\n    });\n  }\n};\n\nconst handleCallbackFuncParameters = func => {\n  const parameters = getFunctionParameters(func);\n  const handler = {\n    getOwnPropertyDescriptor(target, keyIndex) {\n      const key = keyIndex.split(\"__-__\")[0];\n      const index = parseInt(keyIndex.split(\"__-__\")[1]);\n\n      if (key === \"game\" && index === 0 || key === \"round\" && index === 1 || key === \"stage\" && index === 2) {\n        return;\n      } else if (key === \"players\") {\n        throw new Error(\"the \\\"players\\\" argument has been deprecated, use \\\"game.players\\\" instead\");\n      } else {\n        throw new Error(\"\\\"\".concat(key, \"\\\" property is not allowed on this callback\"));\n      }\n    }\n\n  };\n  const proxy = new Proxy({}, handler);\n  parameters.forEach((key, index) => {\n    const keyIndex = key + \"__-__\" + index;\n    Object.getOwnPropertyDescriptor(proxy, keyIndex);\n  });\n}; // Maybe could do better...\n\n\nconst config = {\n  bots: {}\n};\nconst Empirica = {\n  // New name for init: gameInit\n  gameInit(func) {\n    config.gameInit = func;\n  },\n\n  bot(name, obj) {\n    if (config.bots[name]) {\n      throw \"Bot \\\"\".concat(name, \"\\\" was declared twice!\");\n    }\n\n    config.bots[name] = obj;\n  },\n\n  onGameStart(func) {\n    config.onGameStart = function () {\n      return safeCallback(\"onGameStart\", func, arguments);\n    };\n  },\n\n  onRoundStart(func) {\n    config.onRoundStart = function () {\n      return safeCallback(\"onRoundStart\", func, arguments);\n    };\n  },\n\n  onStageStart(func) {\n    config.onStageStart = function () {\n      return safeCallback(\"onStageStart\", func, arguments);\n    };\n  },\n\n  onStageEnd(func) {\n    config.onStageEnd = function () {\n      return safeCallback(\"onStageEnd\", func, arguments);\n    };\n  },\n\n  onRoundEnd(func) {\n    config.onRoundEnd = function () {\n      return safeCallback(\"onRoundEnd\", func, arguments);\n    };\n  },\n\n  onGameEnd(func) {\n    config.onGameEnd = function () {\n      return safeCallback(\"onGameEnd\", func, arguments);\n    };\n  },\n\n  onSet(func) {\n    config.onSet = function () {\n      return safeCallback(\"onSet\", func, arguments);\n    };\n  },\n\n  onAppend(func) {\n    config.onAppend = function () {\n      return safeCallback(\"onAppend\", func, arguments);\n    };\n  },\n\n  onChange(func) {\n    config.onChange = function () {\n      return safeCallback(\"onChange\", func, arguments);\n    };\n  },\n\n  onSubmit(func) {\n    config.onSubmit = function () {\n      return safeCallback(\"onSubmit\", func, arguments);\n    };\n  }\n\n};\nmodule.exportDefault(Empirica);\n// Help access to server only modules from shared modules\nshared.playerIdForConn = playerIdForConn;\nshared.callOnChange = callOnChange;\nshared.callOnSubmit = callOnSubmit;","map":{"version":3,"sources":["packages/empirica:core/server.js"],"names":["module","export","config","link","SimpleSchema","default","v","playerIdForConn","callOnChange","callOnSubmit","earlyExitGame","shared","getFunctionParameters","Games","debug","safeCallback","name","func","arguments","handleCallbackFuncParameters","game","findOne","_id","finishedAt","console","log","apply","err","error","call","gameId","endReason","status","parameters","handler","getOwnPropertyDescriptor","target","keyIndex","key","split","index","parseInt","Error","proxy","Proxy","forEach","Object","bots","Empirica","gameInit","bot","obj","onGameStart","onRoundStart","onStageStart","onStageEnd","onRoundEnd","onGameEnd","onSet","onAppend","onChange","onSubmit","exportDefault"],"mappings":"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","sourcesContent":["import \"./startup/server/index.js\";\n\nimport SimpleSchema from \"simpl-schema\";\nSimpleSchema.debug = true;\n\nimport { playerIdForConn } from \"./startup/server/connections.js\";\nimport { callOnChange } from \"./api/server/onchange.js\";\nimport { callOnSubmit } from \"./api/server/onsubmit.js\";\nimport { earlyExitGame } from \"./api/games/methods.js\";\nimport shared from \"./shared\";\nimport { getFunctionParameters } from \"./lib/utils\";\nimport { Games } from \"./api/games/games.js\";\n\nconst safeCallback = function(name, func, arguments) {\n  try {\n    switch (name) {\n      case \"onGameStart\":\n      case \"onRoundStart\":\n      case \"onStageStart\":\n      case \"onStageEnd\":\n      case \"onRoundEnd\":\n      case \"onGameEnd\":\n        handleCallbackFuncParameters(func);\n        break;\n\n      default:\n        break;\n    }\n\n    const game = Games.findOne(arguments[0]._id);\n\n    if (game.finishedAt) {\n      console.log(\"safeCallback: game already ended.\");\n      return;\n    }\n\n    return func.apply(this, arguments);\n  } catch (err) {\n    console.error(`Fatal error encounter calling Empirica.${name}:`);\n    console.error(err);\n    const game = arguments[0];\n\n    earlyExitGame.call({\n      gameId: game._id,\n      endReason: `Failed on ${name} callback`,\n      status: \"failed\"\n    });\n  }\n};\n\nconst handleCallbackFuncParameters = func => {\n  const parameters = getFunctionParameters(func);\n  const handler = {\n    getOwnPropertyDescriptor(target, keyIndex) {\n      const key = keyIndex.split(\"__-__\")[0];\n      const index = parseInt(keyIndex.split(\"__-__\")[1]);\n      if (\n        (key === \"game\" && index === 0) ||\n        (key === \"round\" && index === 1) ||\n        (key === \"stage\" && index === 2)\n      ) {\n        return;\n      } else if (key === \"players\") {\n        throw new Error(\n          `the \"players\" argument has been deprecated, use \"game.players\" instead`\n        );\n      } else {\n        throw new Error(`\"${key}\" property is not allowed on this callback`);\n      }\n    }\n  };\n\n  const proxy = new Proxy({}, handler);\n  parameters.forEach((key, index) => {\n    const keyIndex = key + \"__-__\" + index;\n    Object.getOwnPropertyDescriptor(proxy, keyIndex);\n  });\n};\n\n// Maybe could do better...\nconst config = { bots: {} };\n\nconst Empirica = {\n  // New name for init: gameInit\n  gameInit(func) {\n    config.gameInit = func;\n  },\n\n  bot(name, obj) {\n    if (config.bots[name]) {\n      throw `Bot \"${name}\" was declared twice!`;\n    }\n    config.bots[name] = obj;\n  },\n\n  onGameStart(func) {\n    config.onGameStart = function() {\n      return safeCallback(\"onGameStart\", func, arguments);\n    };\n  },\n\n  onRoundStart(func) {\n    config.onRoundStart = function() {\n      return safeCallback(\"onRoundStart\", func, arguments);\n    };\n  },\n\n  onStageStart(func) {\n    config.onStageStart = function() {\n      return safeCallback(\"onStageStart\", func, arguments);\n    };\n  },\n\n  onStageEnd(func) {\n    config.onStageEnd = function() {\n      return safeCallback(\"onStageEnd\", func, arguments);\n    };\n  },\n\n  onRoundEnd(func) {\n    config.onRoundEnd = function() {\n      return safeCallback(\"onRoundEnd\", func, arguments);\n    };\n  },\n\n  onGameEnd(func) {\n    config.onGameEnd = function() {\n      return safeCallback(\"onGameEnd\", func, arguments);\n    };\n  },\n\n  onSet(func) {\n    config.onSet = function() {\n      return safeCallback(\"onSet\", func, arguments);\n    };\n  },\n\n  onAppend(func) {\n    config.onAppend = function() {\n      return safeCallback(\"onAppend\", func, arguments);\n    };\n  },\n\n  onChange(func) {\n    config.onChange = function() {\n      return safeCallback(\"onChange\", func, arguments);\n    };\n  },\n\n  onSubmit(func) {\n    config.onSubmit = function() {\n      return safeCallback(\"onSubmit\", func, arguments);\n    };\n  }\n};\n\nexport { config };\nexport default Empirica;\n\n// Help access to server only modules from shared modules\nshared.playerIdForConn = playerIdForConn;\nshared.callOnChange = callOnChange;\nshared.callOnSubmit = callOnSubmit;\n"]},"sourceType":"module","hash":"210668e4799bc14378e188fb11ea1bb9a9f7d97c"}
