{"metadata":{},"options":{"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/Users/tilenbabnik/Desktop/pgg/packages/empirica:core/api/players/methods.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"packages/empirica:core/api/players/methods.js","filename":"/Users/tilenbabnik/Desktop/pgg/packages/empirica:core/api/players/methods.js","passPerPreset":false,"envName":"development","cwd":"/Users/tilenbabnik/Desktop/pgg","root":"/Users/tilenbabnik/Desktop/pgg","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"CallExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"MemberExpression":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true,"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.9.2","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"Program":{"enter":[null],"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/Users/tilenbabnik/Desktop/pgg/packages/empirica:core/api/players/methods.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/empirica:core/api/players/methods.js"}},"code":"var _regeneratorRuntime;\n\nmodule.link(\"@babel/runtime/regenerator\", {\n  default: function (v) {\n    _regeneratorRuntime = v;\n  }\n}, 0);\nmodule.export({\n  createPlayer: function () {\n    return createPlayer;\n  },\n  playerReady: function () {\n    return playerReady;\n  },\n  updatePlayerData: function () {\n    return updatePlayerData;\n  },\n  markPlayerExitStepDone: function () {\n    return markPlayerExitStepDone;\n  },\n  extendPlayerTimeoutWait: function () {\n    return extendPlayerTimeoutWait;\n  },\n  endPlayerTimeoutWait: function () {\n    return endPlayerTimeoutWait;\n  },\n  earlyExitPlayer: function () {\n    return earlyExitPlayer;\n  },\n  earlyExitPlayerLobby: function () {\n    return earlyExitPlayerLobby;\n  },\n  retireSinglePlayer: function () {\n    return retireSinglePlayer;\n  },\n  retireGameFullPlayers: function () {\n    return retireGameFullPlayers;\n  },\n  playerWasRetired: function () {\n    return playerWasRetired;\n  },\n  updatePlayerStatus: function () {\n    return updatePlayerStatus;\n  }\n});\nvar ValidatedMethod;\nmodule.link(\"meteor/mdg:validated-method\", {\n  ValidatedMethod: function (v) {\n    ValidatedMethod = v;\n  }\n}, 0);\nvar SimpleSchema;\nmodule.link(\"simpl-schema\", {\n  \"default\": function (v) {\n    SimpleSchema = v;\n  }\n}, 1);\nvar Batches;\nmodule.link(\"../batches/batches.js\", {\n  Batches: function (v) {\n    Batches = v;\n  }\n}, 2);\nvar GameLobbies;\nmodule.link(\"../game-lobbies/game-lobbies\", {\n  GameLobbies: function (v) {\n    GameLobbies = v;\n  }\n}, 3);\nvar IdSchema;\nmodule.link(\"../default-schemas.js\", {\n  IdSchema: function (v) {\n    IdSchema = v;\n  }\n}, 4);\nvar LobbyConfigs;\nmodule.link(\"../lobby-configs/lobby-configs.js\", {\n  LobbyConfigs: function (v) {\n    LobbyConfigs = v;\n  }\n}, 5);\nvar Games;\nmodule.link(\"../games/games.js\", {\n  Games: function (v) {\n    Games = v;\n  }\n}, 6);\nvar Players;\nmodule.link(\"./players\", {\n  Players: function (v) {\n    Players = v;\n  }\n}, 7);\nvar exitStatuses;\nmodule.link(\"./players.js\", {\n  exitStatuses: function (v) {\n    exitStatuses = v;\n  }\n}, 8);\nvar sleep, weightedRandom;\nmodule.link(\"../../lib/utils.js\", {\n  sleep: function (v) {\n    sleep = v;\n  },\n  weightedRandom: function (v) {\n    weightedRandom = v;\n  }\n}, 9);\nvar shared;\nmodule.link(\"../../shared.js\", {\n  \"default\": function (v) {\n    shared = v;\n  }\n}, 10);\nvar gameLobbyLock;\nmodule.link(\"../../gameLobby-lock.js\", {\n  \"default\": function (v) {\n    gameLobbyLock = v;\n  }\n}, 11);\nvar createPlayer = new ValidatedMethod({\n  name: \"Players.methods.create\",\n  validate: new SimpleSchema({\n    id: {\n      type: String\n    },\n    urlParams: {\n      type: Object,\n      blackbox: true,\n      defaultValue: {}\n    }\n  }).validator(),\n  run: function (player) {\n    // Find the first running batch (in order of running started time)\n    var batch = Batches.findOne({\n      status: \"running\",\n      full: false\n    }, {\n      sort: {\n        runningAt: 1\n      }\n    });\n\n    if (!batch) {\n      // The UI should update and realize there is no batch available\n      // This should be a rare case where a fraction of a second of\n      // desynchornisation when the last available batch just finished.\n      // If this is the case, since the user exist in the DB at this point\n      // but has no lobby assigned, and the UI will soon determine there\n      // is no available game, the UI will switch to \"No experiments\n      // available\", nothing else to do.\n      return;\n    } // TODO: MAYBE, add verification that the user is not current connected\n    // elsewhere and this is not a flagrant impersonation. Note that is\n    // extremely difficult to guaranty. Could also add verification of user's\n    // id with email verication for example. For now the assumption is that\n    // there is no immediate reason or long-term motiviation for people to hack\n    // each other's player account.\n\n\n    var existing = Players.findOne({\n      id: player.id\n    }); // If the player already has a game lobby assigned, no need to\n    // re-initialize them\n\n    if (existing && existing.gameLobbyId) {\n      return existing._id;\n    }\n\n    if (existing) {\n      player = existing;\n    } else {\n      // Because of a bug in SimpleSchema around blackbox: true, skipping\n      // validation here. Validation did happen at the method level though.\n      player._id = Players.insert(player, {\n        filter: false,\n        validate: false\n      });\n    } // Looking for all lobbies for batch (for which that game has not started yet)\n\n\n    var lobbies = GameLobbies.find({\n      batchId: batch._id,\n      status: \"running\",\n      timedOutAt: {\n        $exists: false\n      },\n      gameId: {\n        $exists: false\n      }\n    }).fetch();\n\n    if (lobbies.length === 0) {\n      // This is the same case as when there are no batches available.\n      return;\n    } // Let's first try to find lobbies for which their queue isn't full yet\n\n\n    var lobbyPool = lobbies.filter(function (l) {\n      return l.availableCount > l.queuedPlayerIds.length;\n    }); // If no lobbies still have \"availability\", just fill any lobby\n\n    if (lobbyPool.length === 0) {\n      lobbyPool = lobbies;\n    } // Book proportially to total expected playerCount\n\n\n    var weigthedLobbyPool = lobbyPool.map(function (lobby) {\n      return {\n        value: lobby,\n        weight: lobby.availableCount\n      };\n    }); // Choose a lobby in the available weigthed pool\n\n    var lobby = weightedRandom(weigthedLobbyPool)(); // Adding the player to specified lobby queue\n\n    GameLobbies.update(lobby._id, {\n      $addToSet: {\n        queuedPlayerIds: player._id\n      }\n    });\n    var gameLobbyId = lobby._id;\n    var $set = {\n      gameLobbyId: gameLobbyId\n    }; // Check if there will be instructions\n\n    var skipInstructions = lobby.debugMode; // If there are no instruction, mark the player as ready immediately\n\n    if (skipInstructions) {\n      $set.readyAt = new Date();\n    }\n\n    Players.update(player._id, {\n      $set: $set\n    }); // If there are no instruction, player is ready, notify the lobby\n\n    if (skipInstructions) {\n      GameLobbies.update(gameLobbyId, {\n        $addToSet: {\n          playerIds: player._id\n        }\n      });\n    }\n\n    return player._id;\n  }\n});\nvar playerReady = new ValidatedMethod({\n  name: \"Players.methods.ready\",\n  validate: IdSchema.validator(),\n  run: function () {\n    function _callee(_ref) {\n      var _id;\n\n      return _regeneratorRuntime.async(function () {\n        function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _id = _ref._id;\n\n                if (Meteor.isServer) {\n                  _context.next = 3;\n                  break;\n                }\n\n                return _context.abrupt(\"return\");\n\n              case 3:\n                _context.prev = 3;\n\n              case 4:\n                if (assignToLobby(_id)) {\n                  _context.next = 9;\n                  break;\n                }\n\n                _context.next = 7;\n                return _regeneratorRuntime.awrap(sleep(1000));\n\n              case 7:\n                _context.next = 4;\n                break;\n\n              case 9:\n                _context.next = 14;\n                break;\n\n              case 11:\n                _context.prev = 11;\n                _context.t0 = _context[\"catch\"](3);\n                console.error(\"Players.methods.ready\", _context.t0);\n\n              case 14:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }\n\n        return _callee$;\n      }(), null, null, [[3, 11]], Promise);\n    }\n\n    return _callee;\n  }()\n});\n\nfunction assignToLobby(_id) {\n  var player = Players.findOne(_id);\n\n  if (!player) {\n    throw \"unknown ready player: \" + _id;\n  }\n\n  var readyAt = player.readyAt,\n      gameLobbyId = player.gameLobbyId;\n\n  if (readyAt) {\n    // Already ready\n    return true;\n  }\n\n  var lobby = GameLobbies.findOne(gameLobbyId);\n\n  if (!lobby) {\n    throw \"unknown lobby for ready player: \" + _id;\n  } // GameLobby is locked.\n\n\n  if (gameLobbyLock[gameLobbyId]) {\n    return false;\n  } // Game is Full, bail the player\n\n\n  if (lobby.playerIds.length === lobby.availableCount) {\n    // User already ready, something happened out of order\n    if (lobby.playerIds.includes(_id)) {\n      return true;\n    } // Mark the player's participation attemp as failed if\n    // not already marked exited\n\n\n    Players.update({\n      _id: _id,\n      exitAt: {\n        $exists: false\n      }\n    }, {\n      $set: {\n        exitAt: new Date(),\n        exitStatus: \"gameFull\"\n      }\n    });\n    return true;\n  } // Try to update the GameLobby with the playerIds we just queried.\n\n\n  GameLobbies.update({\n    _id: gameLobbyId,\n    playerIds: lobby.playerIds\n  }, {\n    $addToSet: {\n      playerIds: _id\n    }\n  }); // If the playerId insert succeeded (playerId WAS added to playerIds),\n  // mark the user record as ready and potentially start the individual\n  // lobby timer.\n\n  var lobbyUpdated = GameLobbies.findOne(gameLobbyId);\n\n  if (lobbyUpdated.playerIds.includes(_id)) {\n    // If it did work, mark player as ready\n    $set = {\n      readyAt: new Date()\n    }; // If it's an individual lobby timeout, mark the first timer as started.\n\n    var lobbyConfig = LobbyConfigs.findOne(lobbyUpdated.lobbyConfigId);\n\n    if (lobbyConfig.timeoutType === \"individual\") {\n      $set.timeoutStartedAt = new Date();\n      $set.timeoutWaitCount = 1;\n    }\n\n    Players.update(_id, {\n      $set: $set\n    });\n    return true;\n  } // If the playerId insert failed (playerId NOT added to playerIds), the\n  // playerIds has changed since it was queried and the lobby might not\n  // have any available slots left, loop and retry.\n\n\n  return false;\n}\n\nvar updatePlayerData = new ValidatedMethod({\n  name: \"Players.methods.updateData\",\n  validate: new SimpleSchema({\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    },\n    key: {\n      type: String\n    },\n    value: {\n      type: String\n    },\n    append: {\n      type: Boolean,\n      optional: true\n    },\n    noCallback: {\n      type: Boolean,\n      optional: true\n    }\n  }).validator(),\n  run: function (_ref2) {\n    var _update;\n\n    var playerId = _ref2.playerId,\n        key = _ref2.key,\n        value = _ref2.value,\n        append = _ref2.append,\n        noCallback = _ref2.noCallback;\n    var player = Players.findOne(playerId);\n\n    if (!player) {\n      throw new Error(\"player not found\");\n    } // TODO check can update this record player\n\n\n    var val = JSON.parse(value);\n    var update = (_update = {}, _update[\"data.\" + key] = val, _update);\n    var modifier = append ? {\n      $push: update\n    } : {\n      $set: update\n    };\n    Players.update(playerId, modifier, {\n      autoConvert: false,\n      filter: false,\n      validate: false,\n      trimStrings: false,\n      removeEmptyStrings: false\n    });\n\n    if (Meteor.isServer && !noCallback) {\n      shared.callOnChange({\n        playerId: playerId,\n        player: player,\n        key: key,\n        value: val,\n        prevValue: player.data && player.data[key],\n        append: append\n      });\n    }\n  }\n});\nvar markPlayerExitStepDone = new ValidatedMethod({\n  name: \"Players.methods.markExitStepDone\",\n  validate: new SimpleSchema({\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    },\n    stepName: {\n      type: String\n    }\n  }).validator(),\n  run: function (_ref3) {\n    var playerId = _ref3.playerId,\n        stepName = _ref3.stepName;\n    var player = Players.findOne(playerId);\n\n    if (!player) {\n      throw new Error(\"player not found\");\n    } // TODO check can update this record player\n\n\n    Players.update(playerId, {\n      $addToSet: {\n        exitStepsDone: stepName\n      }\n    });\n  }\n});\nvar extendPlayerTimeoutWait = new ValidatedMethod({\n  name: \"Players.methods.extendTimeoutWait\",\n  validate: new SimpleSchema({\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    }\n  }).validator(),\n  run: function (_ref4) {\n    var playerId = _ref4.playerId;\n    var player = Players.findOne(playerId);\n\n    if (!player) {\n      throw new Error(\"player not found\");\n    }\n\n    Players.update(playerId, {\n      $inc: {\n        timeoutWaitCount: 1\n      },\n      $set: {\n        timeoutStartedAt: new Date()\n      }\n    });\n  }\n});\nvar endPlayerTimeoutWait = new ValidatedMethod({\n  name: \"Players.methods.endTimeoutWait\",\n  validate: new SimpleSchema({\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    }\n  }).validator(),\n  run: function (_ref5) {\n    var playerId = _ref5.playerId;\n    var player = Players.findOne(playerId);\n\n    if (!player) {\n      throw new Error(\"player not found\");\n    }\n\n    Players.update(playerId, {\n      $set: {\n        exitStatus: \"playerEndedLobbyWait\",\n        exitAt: new Date()\n      }\n    });\n    GameLobbies.update(player.gameLobbyId, {\n      $pull: {\n        playerIds: playerId // We keep the player in queuedPlayerIds so they will still have the\n        // fact they were in a lobby available in the UI, and so we can show\n        // them the exit steps.\n\n      }\n    });\n  }\n});\nvar earlyExitPlayer = new ValidatedMethod({\n  name: \"Players.methods.admin.earlyExitPlayer\",\n  validate: new SimpleSchema({\n    exitReason: {\n      label: \"Reason for Exit\",\n      type: String,\n      regEx: /[a-zA-Z0-9_]+/\n    },\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    },\n    gameId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    }\n  }).validator(),\n  run: function (_ref6) {\n    var exitReason = _ref6.exitReason,\n        playerId = _ref6.playerId,\n        gameId = _ref6.gameId;\n\n    if (!Meteor.isServer) {\n      return;\n    }\n\n    var game = Games.findOne(gameId);\n\n    if (!game) {\n      throw new Error(\"game not found\");\n    }\n\n    if (game && game.finishedAt) {\n      if (Meteor.isDevelopment) {\n        console.log(\"\\n\\ngame already ended!\");\n      }\n\n      return;\n    }\n\n    var currentPlayer = Players.findOne(playerId);\n\n    if (currentPlayer && currentPlayer.exitAt) {\n      if (Meteor.isDevelopment) {\n        console.log(\"\\nplayer already exited!\");\n      }\n\n      return;\n    }\n\n    Players.update(playerId, {\n      $set: {\n        exitAt: new Date(),\n        exitStatus: \"custom\",\n        exitReason: exitReason\n      }\n    });\n    var players = Players.find({\n      gameId: gameId\n    }).fetch();\n    var onlinePlayers = players.filter(function (player) {\n      return !player.exitAt;\n    });\n\n    if (!onlinePlayers || onlinePlayers && onlinePlayers.length === 0) {\n      Games.update(gameId, {\n        $set: {\n          finishedAt: new Date(),\n          status: \"custom\",\n          endReason: \"finished_early\"\n        }\n      });\n      GameLobbies.update({\n        gameId: gameId\n      }, {\n        $set: {\n          status: \"custom\",\n          endReason: \"finished_early\"\n        }\n      });\n    }\n  }\n});\nvar earlyExitPlayerLobby = new ValidatedMethod({\n  name: \"Players.methods.admin.earlyExitPlayerLobby\",\n  validate: new SimpleSchema({\n    exitReason: {\n      label: \"Reason for Exit\",\n      type: String,\n      regEx: /[a-zA-Z0-9_]+/\n    },\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    },\n    gameLobbyId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    }\n  }).validator(),\n  run: function (_ref7) {\n    var exitReason = _ref7.exitReason,\n        playerId = _ref7.playerId,\n        gameLobbyId = _ref7.gameLobbyId;\n\n    if (!Meteor.isServer) {\n      return;\n    }\n\n    var gameLobby = GameLobbies.findOne(gameLobbyId);\n\n    if (!gameLobby) {\n      throw new Error(\"gameLobby not found\");\n    }\n\n    var currentPlayer = Players.findOne(playerId);\n\n    if (currentPlayer && currentPlayer.exitAt) {\n      if (Meteor.isDevelopment) {\n        console.log(\"\\nplayer already exited!\");\n      }\n\n      return;\n    }\n\n    Players.update(playerId, {\n      $set: {\n        exitAt: new Date(),\n        exitStatus: \"custom\",\n        exitReason: exitReason\n      }\n    });\n  }\n});\nvar retireSinglePlayer = new ValidatedMethod({\n  name: \"Players.methods.admin.retireSingle\",\n  validate: new SimpleSchema({\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    }\n  }).validator(),\n  run: function (_ref8) {\n    var playerId = _ref8.playerId;\n\n    if (!playerId) {\n      throw new Error(\"empty playerId\");\n    }\n\n    if (!this.userId) {\n      throw new Error(\"unauthorized\");\n    }\n\n    var player = Players.findOne({\n      _id: playerId,\n      retiredAt: {\n        $exists: false\n      }\n    });\n\n    if (!player) {\n      throw new Error(\"Player not found\");\n    }\n\n    var timestamp = new Date().toISOString();\n    Players.update(playerId, {\n      $set: {\n        id: player.id + \" (Retired custom at \" + timestamp + \")\",\n        retiredAt: new Date(),\n        retiredReason: \"custom\"\n      }\n    });\n    return player;\n  }\n});\nvar retireGameFullPlayers = new ValidatedMethod({\n  name: \"Players.methods.admin.retireGameFull\",\n  validate: new SimpleSchema({\n    retiredReason: {\n      label: \"Retired Reason\",\n      type: String,\n      optional: true,\n      allowedValues: exitStatuses\n    }\n  }).validator(),\n  run: function (_ref9) {\n    var retiredReason = _ref9.retiredReason;\n\n    if (!this.userId) {\n      throw new Error(\"unauthorized\");\n    }\n\n    var players = Players.find({\n      exitStatus: retiredReason,\n      retiredAt: {\n        $exists: false\n      }\n    }).fetch();\n    var timestamp = new Date().toISOString();\n\n    for (var i = 0; i < players.length; i++) {\n      var player = players[i];\n      Players.update(player._id, {\n        $set: {\n          id: player.id + \" (Retired \" + retiredReason + \" at \" + timestamp + \")\",\n          retiredAt: new Date(),\n          retiredReason: retiredReason\n        }\n      });\n    }\n\n    return players.length;\n  }\n});\nvar playerWasRetired = new ValidatedMethod({\n  name: \"Players.methods.playerWasRetired\",\n  validate: IdSchema.validator(),\n  run: function (_ref10) {\n    var _id = _ref10._id;\n    return Boolean(Players.findOne({\n      _id: _id,\n      exitStatus: {\n        $exists: true\n      },\n      retiredAt: {\n        $exists: true\n      }\n    }));\n  }\n});\nvar updatePlayerStatus = new ValidatedMethod({\n  name: \"Players.methods.updateStatus\",\n  validate: new SimpleSchema({\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    },\n    idle: {\n      type: Boolean\n    },\n    lastActivityAt: {\n      type: Date\n    }\n  }).validator(),\n  run: function (_ref11) {\n    var playerId = _ref11.playerId,\n        idle = _ref11.idle,\n        lastActivityAt = _ref11.lastActivityAt;\n\n    if (Meteor.isServer) {\n      var playerIdConn = shared.playerIdForConn(this.connection);\n\n      if (!playerIdConn) {\n        return;\n      }\n\n      if (playerId !== playerIdConn) {\n        console.error(\"Attempting to update player status from wrong connection\");\n        return;\n      }\n    }\n\n    Players.update(playerId, {\n      $set: {\n        idle: idle,\n        lastActivityAt: lastActivityAt\n      }\n    });\n  }\n});","map":{"version":3,"sources":["packages/empirica:core/api/players/methods.js"],"names":["_regeneratorRuntime","module","link","default","v","export","createPlayer","playerReady","updatePlayerData","markPlayerExitStepDone","extendPlayerTimeoutWait","endPlayerTimeoutWait","earlyExitPlayer","earlyExitPlayerLobby","retireSinglePlayer","retireGameFullPlayers","playerWasRetired","updatePlayerStatus","ValidatedMethod","SimpleSchema","Batches","GameLobbies","IdSchema","LobbyConfigs","Games","Players","exitStatuses","sleep","weightedRandom","shared","gameLobbyLock","name","validate","id","type","String","urlParams","Object","blackbox","defaultValue","validator","run","player","batch","findOne","status","full","sort","runningAt","existing","gameLobbyId","_id","insert","filter","lobbies","find","batchId","timedOutAt","$exists","gameId","fetch","length","lobbyPool","l","availableCount","queuedPlayerIds","weigthedLobbyPool","map","lobby","value","weight","update","$addToSet","$set","skipInstructions","debugMode","readyAt","Date","playerIds","Meteor","isServer","assignToLobby","console","error","includes","exitAt","exitStatus","lobbyUpdated","lobbyConfig","lobbyConfigId","timeoutType","timeoutStartedAt","timeoutWaitCount","playerId","regEx","RegEx","Id","key","append","Boolean","optional","noCallback","Error","val","JSON","parse","modifier","$push","autoConvert","trimStrings","removeEmptyStrings","callOnChange","prevValue","data","stepName","exitStepsDone","$inc","$pull","exitReason","label","game","finishedAt","isDevelopment","log","currentPlayer","players","onlinePlayers","endReason","gameLobby","userId","retiredAt","timestamp","toISOString","retiredReason","allowedValues","i","idle","lastActivityAt","playerIdConn","playerIdForConn","connection"],"mappings":"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","sourcesContent":["import { ValidatedMethod } from \"meteor/mdg:validated-method\";\nimport SimpleSchema from \"simpl-schema\";\n\nimport { Batches } from \"../batches/batches.js\";\nimport { GameLobbies } from \"../game-lobbies/game-lobbies\";\nimport { IdSchema } from \"../default-schemas.js\";\nimport { LobbyConfigs } from \"../lobby-configs/lobby-configs.js\";\nimport { Games } from \"../games/games.js\";\nimport { Players } from \"./players\";\nimport { exitStatuses } from \"./players.js\";\nimport { sleep, weightedRandom } from \"../../lib/utils.js\";\nimport shared from \"../../shared.js\";\nimport gameLobbyLock from \"../../gameLobby-lock.js\";\n\nexport const createPlayer = new ValidatedMethod({\n  name: \"Players.methods.create\",\n\n  validate: new SimpleSchema({\n    id: {\n      type: String\n    },\n    urlParams: {\n      type: Object,\n      blackbox: true,\n      defaultValue: {}\n    }\n  }).validator(),\n\n  run(player) {\n    // Find the first running batch (in order of running started time)\n    const batch = Batches.findOne(\n      { status: \"running\", full: false },\n      { sort: { runningAt: 1 } }\n    );\n\n    if (!batch) {\n      // The UI should update and realize there is no batch available\n      // This should be a rare case where a fraction of a second of\n      // desynchornisation when the last available batch just finished.\n      // If this is the case, since the user exist in the DB at this point\n      // but has no lobby assigned, and the UI will soon determine there\n      // is no available game, the UI will switch to \"No experiments\n      // available\", nothing else to do.\n      return;\n    }\n\n    // TODO: MAYBE, add verification that the user is not current connected\n    // elsewhere and this is not a flagrant impersonation. Note that is\n    // extremely difficult to guaranty. Could also add verification of user's\n    // id with email verication for example. For now the assumption is that\n    // there is no immediate reason or long-term motiviation for people to hack\n    // each other's player account.\n\n    const existing = Players.findOne({ id: player.id });\n\n    // If the player already has a game lobby assigned, no need to\n    // re-initialize them\n    if (existing && existing.gameLobbyId) {\n      return existing._id;\n    }\n\n    if (existing) {\n      player = existing;\n    } else {\n      // Because of a bug in SimpleSchema around blackbox: true, skipping\n      // validation here. Validation did happen at the method level though.\n      player._id = Players.insert(player, {\n        filter: false,\n        validate: false\n      });\n    }\n\n    // Looking for all lobbies for batch (for which that game has not started yet)\n    const lobbies = GameLobbies.find({\n      batchId: batch._id,\n      status: \"running\",\n      timedOutAt: { $exists: false },\n      gameId: { $exists: false }\n    }).fetch();\n\n    if (lobbies.length === 0) {\n      // This is the same case as when there are no batches available.\n      return;\n    }\n\n    // Let's first try to find lobbies for which their queue isn't full yet\n    let lobbyPool = lobbies.filter(\n      l => l.availableCount > l.queuedPlayerIds.length\n    );\n\n    // If no lobbies still have \"availability\", just fill any lobby\n    if (lobbyPool.length === 0) {\n      lobbyPool = lobbies;\n    }\n\n    // Book proportially to total expected playerCount\n    const weigthedLobbyPool = lobbyPool.map(lobby => {\n      return {\n        value: lobby,\n        weight: lobby.availableCount\n      };\n    });\n\n    // Choose a lobby in the available weigthed pool\n    const lobby = weightedRandom(weigthedLobbyPool)();\n\n    // Adding the player to specified lobby queue\n    GameLobbies.update(lobby._id, {\n      $addToSet: {\n        queuedPlayerIds: player._id\n      }\n    });\n\n    const gameLobbyId = lobby._id;\n    const $set = { gameLobbyId };\n\n    // Check if there will be instructions\n    let skipInstructions = lobby.debugMode;\n\n    // If there are no instruction, mark the player as ready immediately\n    if (skipInstructions) {\n      $set.readyAt = new Date();\n    }\n\n    Players.update(player._id, { $set });\n\n    // If there are no instruction, player is ready, notify the lobby\n    if (skipInstructions) {\n      GameLobbies.update(gameLobbyId, {\n        $addToSet: { playerIds: player._id }\n      });\n    }\n\n    return player._id;\n  }\n});\n\nexport const playerReady = new ValidatedMethod({\n  name: \"Players.methods.ready\",\n\n  validate: IdSchema.validator(),\n\n  async run({ _id }) {\n    if (!Meteor.isServer) {\n      return;\n    }\n\n    try {\n      // Lobby might be locked if game is currently being created.\n      // We retry until lobby is unlocked.\n      while (!assignToLobby(_id)) {\n        await sleep(1000);\n      }\n    } catch (error) {\n      console.error(\"Players.methods.ready\", error);\n    }\n  }\n});\n\nfunction assignToLobby(_id) {\n  const player = Players.findOne(_id);\n\n  if (!player) {\n    throw `unknown ready player: ${_id}`;\n  }\n  const { readyAt, gameLobbyId } = player;\n\n  if (readyAt) {\n    // Already ready\n    return true;\n  }\n\n  const lobby = GameLobbies.findOne(gameLobbyId);\n\n  if (!lobby) {\n    throw `unknown lobby for ready player: ${_id}`;\n  }\n\n  // GameLobby is locked.\n  if (gameLobbyLock[gameLobbyId]) {\n    return false;\n  }\n\n  // Game is Full, bail the player\n  if (lobby.playerIds.length === lobby.availableCount) {\n    // User already ready, something happened out of order\n    if (lobby.playerIds.includes(_id)) {\n      return true;\n    }\n\n    // Mark the player's participation attemp as failed if\n    // not already marked exited\n    Players.update(\n      {\n        _id,\n        exitAt: { $exists: false }\n      },\n      {\n        $set: {\n          exitAt: new Date(),\n          exitStatus: \"gameFull\"\n        }\n      }\n    );\n\n    return true;\n  }\n\n  // Try to update the GameLobby with the playerIds we just queried.\n  GameLobbies.update(\n    { _id: gameLobbyId, playerIds: lobby.playerIds },\n    {\n      $addToSet: { playerIds: _id }\n    }\n  );\n\n  // If the playerId insert succeeded (playerId WAS added to playerIds),\n  // mark the user record as ready and potentially start the individual\n  // lobby timer.\n  const lobbyUpdated = GameLobbies.findOne(gameLobbyId);\n  if (lobbyUpdated.playerIds.includes(_id)) {\n    // If it did work, mark player as ready\n    $set = { readyAt: new Date() };\n\n    // If it's an individual lobby timeout, mark the first timer as started.\n    const lobbyConfig = LobbyConfigs.findOne(lobbyUpdated.lobbyConfigId);\n    if (lobbyConfig.timeoutType === \"individual\") {\n      $set.timeoutStartedAt = new Date();\n      $set.timeoutWaitCount = 1;\n    }\n\n    Players.update(_id, { $set });\n    return true;\n  }\n\n  // If the playerId insert failed (playerId NOT added to playerIds), the\n  // playerIds has changed since it was queried and the lobby might not\n  // have any available slots left, loop and retry.\n  return false;\n}\n\nexport const updatePlayerData = new ValidatedMethod({\n  name: \"Players.methods.updateData\",\n\n  validate: new SimpleSchema({\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    },\n    key: {\n      type: String\n    },\n    value: {\n      type: String\n    },\n    append: {\n      type: Boolean,\n      optional: true\n    },\n    noCallback: {\n      type: Boolean,\n      optional: true\n    }\n  }).validator(),\n\n  run({ playerId, key, value, append, noCallback }) {\n    const player = Players.findOne(playerId);\n    if (!player) {\n      throw new Error(\"player not found\");\n    }\n    // TODO check can update this record player\n\n    const val = JSON.parse(value);\n    let update = { [`data.${key}`]: val };\n    const modifier = append ? { $push: update } : { $set: update };\n\n    Players.update(playerId, modifier, {\n      autoConvert: false,\n      filter: false,\n      validate: false,\n      trimStrings: false,\n      removeEmptyStrings: false\n    });\n\n    if (Meteor.isServer && !noCallback) {\n      shared.callOnChange({\n        playerId,\n        player,\n        key,\n        value: val,\n        prevValue: player.data && player.data[key],\n        append\n      });\n    }\n  }\n});\n\nexport const markPlayerExitStepDone = new ValidatedMethod({\n  name: \"Players.methods.markExitStepDone\",\n\n  validate: new SimpleSchema({\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    },\n    stepName: {\n      type: String\n    }\n  }).validator(),\n\n  run({ playerId, stepName }) {\n    const player = Players.findOne(playerId);\n    if (!player) {\n      throw new Error(\"player not found\");\n    }\n    // TODO check can update this record player\n\n    Players.update(playerId, { $addToSet: { exitStepsDone: stepName } });\n  }\n});\n\nexport const extendPlayerTimeoutWait = new ValidatedMethod({\n  name: \"Players.methods.extendTimeoutWait\",\n\n  validate: new SimpleSchema({\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    }\n  }).validator(),\n\n  run({ playerId }) {\n    const player = Players.findOne(playerId);\n    if (!player) {\n      throw new Error(\"player not found\");\n    }\n\n    Players.update(playerId, {\n      $inc: { timeoutWaitCount: 1 },\n      $set: { timeoutStartedAt: new Date() }\n    });\n  }\n});\n\nexport const endPlayerTimeoutWait = new ValidatedMethod({\n  name: \"Players.methods.endTimeoutWait\",\n\n  validate: new SimpleSchema({\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    }\n  }).validator(),\n\n  run({ playerId }) {\n    const player = Players.findOne(playerId);\n    if (!player) {\n      throw new Error(\"player not found\");\n    }\n\n    Players.update(playerId, {\n      $set: {\n        exitStatus: \"playerEndedLobbyWait\",\n        exitAt: new Date()\n      }\n    });\n    GameLobbies.update(player.gameLobbyId, {\n      $pull: {\n        playerIds: playerId\n        // We keep the player in queuedPlayerIds so they will still have the\n        // fact they were in a lobby available in the UI, and so we can show\n        // them the exit steps.\n      }\n    });\n  }\n});\n\nexport const earlyExitPlayer = new ValidatedMethod({\n  name: \"Players.methods.admin.earlyExitPlayer\",\n\n  validate: new SimpleSchema({\n    exitReason: {\n      label: \"Reason for Exit\",\n      type: String,\n      regEx: /[a-zA-Z0-9_]+/\n    },\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    },\n    gameId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    }\n  }).validator(),\n\n  run({ exitReason, playerId, gameId }) {\n    if (!Meteor.isServer) {\n      return;\n    }\n\n    const game = Games.findOne(gameId);\n\n    if (!game) {\n      throw new Error(\"game not found\");\n    }\n\n    if (game && game.finishedAt) {\n      if (Meteor.isDevelopment) {\n        console.log(\"\\n\\ngame already ended!\");\n      }\n\n      return;\n    }\n\n    const currentPlayer = Players.findOne(playerId);\n\n    if (currentPlayer && currentPlayer.exitAt) {\n      if (Meteor.isDevelopment) {\n        console.log(\"\\nplayer already exited!\");\n      }\n\n      return;\n    }\n\n    Players.update(playerId, {\n      $set: {\n        exitAt: new Date(),\n        exitStatus: \"custom\",\n        exitReason\n      }\n    });\n\n    const players = Players.find({ gameId }).fetch();\n    const onlinePlayers = players.filter(player => !player.exitAt);\n\n    if (!onlinePlayers || (onlinePlayers && onlinePlayers.length === 0)) {\n      Games.update(gameId, {\n        $set: {\n          finishedAt: new Date(),\n          status: \"custom\",\n          endReason: \"finished_early\"\n        }\n      });\n\n      GameLobbies.update(\n        { gameId },\n        {\n          $set: {\n            status: \"custom\",\n            endReason: \"finished_early\"\n          }\n        }\n      );\n    }\n  }\n});\n\nexport const earlyExitPlayerLobby = new ValidatedMethod({\n  name: \"Players.methods.admin.earlyExitPlayerLobby\",\n\n  validate: new SimpleSchema({\n    exitReason: {\n      label: \"Reason for Exit\",\n      type: String,\n      regEx: /[a-zA-Z0-9_]+/\n    },\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    },\n    gameLobbyId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    }\n  }).validator(),\n\n  run({ exitReason, playerId, gameLobbyId }) {\n    if (!Meteor.isServer) {\n      return;\n    }\n\n    const gameLobby = GameLobbies.findOne(gameLobbyId);\n\n    if (!gameLobby) {\n      throw new Error(\"gameLobby not found\");\n    }\n\n    const currentPlayer = Players.findOne(playerId);\n\n    if (currentPlayer && currentPlayer.exitAt) {\n      if (Meteor.isDevelopment) {\n        console.log(\"\\nplayer already exited!\");\n      }\n\n      return;\n    }\n\n    Players.update(playerId, {\n      $set: {\n        exitAt: new Date(),\n        exitStatus: \"custom\",\n        exitReason\n      }\n    });\n  }\n});\n\nexport const retireSinglePlayer = new ValidatedMethod({\n  name: \"Players.methods.admin.retireSingle\",\n\n  validate: new SimpleSchema({\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    }\n  }).validator(),\n\n  run({ playerId }) {\n    if (!playerId) {\n      throw new Error(\"empty playerId\");\n    }\n\n    if (!this.userId) {\n      throw new Error(\"unauthorized\");\n    }\n\n    const player = Players.findOne({\n      _id: playerId,\n      retiredAt: { $exists: false }\n    });\n\n    if (!player) {\n      throw new Error(\"Player not found\");\n    }\n\n    const timestamp = new Date().toISOString();\n\n    Players.update(playerId, {\n      $set: {\n        id: `${player.id} (Retired custom at ${timestamp})`,\n        retiredAt: new Date(),\n        retiredReason: \"custom\"\n      }\n    });\n\n    return player;\n  }\n});\n\nexport const retireGameFullPlayers = new ValidatedMethod({\n  name: \"Players.methods.admin.retireGameFull\",\n\n  validate: new SimpleSchema({\n    retiredReason: {\n      label: \"Retired Reason\",\n      type: String,\n      optional: true,\n      allowedValues: exitStatuses\n    }\n  }).validator(),\n\n  run({ retiredReason }) {\n    if (!this.userId) {\n      throw new Error(\"unauthorized\");\n    }\n\n    const players = Players.find({\n      exitStatus: retiredReason,\n      retiredAt: { $exists: false }\n    }).fetch();\n\n    const timestamp = new Date().toISOString();\n\n    for (let i = 0; i < players.length; i++) {\n      const player = players[i];\n\n      Players.update(player._id, {\n        $set: {\n          id: `${player.id} (Retired ${retiredReason} at ${timestamp})`,\n          retiredAt: new Date(),\n          retiredReason\n        }\n      });\n    }\n\n    return players.length;\n  }\n});\n\nexport const playerWasRetired = new ValidatedMethod({\n  name: \"Players.methods.playerWasRetired\",\n\n  validate: IdSchema.validator(),\n\n  run({ _id }) {\n    return Boolean(\n      Players.findOne({\n        _id,\n        exitStatus: { $exists: true },\n        retiredAt: { $exists: true }\n      })\n    );\n  }\n});\n\nexport const updatePlayerStatus = new ValidatedMethod({\n  name: \"Players.methods.updateStatus\",\n\n  validate: new SimpleSchema({\n    playerId: {\n      type: String,\n      regEx: SimpleSchema.RegEx.Id\n    },\n\n    idle: {\n      type: Boolean\n    },\n\n    lastActivityAt: {\n      type: Date\n    }\n  }).validator(),\n\n  run({ playerId, idle, lastActivityAt }) {\n    if (Meteor.isServer) {\n      const playerIdConn = shared.playerIdForConn(this.connection);\n      if (!playerIdConn) {\n        return;\n      }\n      if (playerId !== playerIdConn) {\n        console.error(\n          \"Attempting to update player status from wrong connection\"\n        );\n        return;\n      }\n    }\n\n    Players.update(playerId, {\n      $set: {\n        idle,\n        lastActivityAt\n      }\n    });\n  }\n});\n"]},"sourceType":"module","hash":"3d14b75e9f21bf265ee7dea4e5ee4d8f28c61045"}
